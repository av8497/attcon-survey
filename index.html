<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Media Behaviour Survey</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

.container {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    min-height: 100vh;
}

.screen {
    padding: 60px 40px;
    min-height: 100vh;
}

.screen h1 {
    font-size: 32px;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 30px;
    text-align: center;
}

.screen h2 {
    font-size: 28px;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 10px;
    text-align: center;
}

.screen-subtitle {
    font-size: 20px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 25px 0 15px 0;
}

.screen p {
    font-size: 16px;
    line-height: 1.6;
    color: #4a4a4a;
    margin-bottom: 15px;
}

.screen ul {
    margin-left: 20px;
    margin-bottom: 20px;
}

.screen li {
    margin-bottom: 8px;
    font-size: 16px;
    color: #4a4a4a;
}

.consent-box {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin: 30px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.consent-box input[type="checkbox"] {
    margin-top: 3px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.consent-box label {
    font-size: 15px;
    line-height: 1.5;
    color: #4a4a4a;
    cursor: pointer;
}

.btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 30px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
}

.btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.demo-screen {
    display: none;
    padding: 40px;
    min-height: 100vh;
}

.demo-screen > p {
    font-size: 15px;
    color: #6a6a6a;
    text-align: center;
    margin-bottom: 30px;
}

.form-group {
    margin-bottom: 24px;
}

.form-group label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: #1a1a1a;
    margin-bottom: 8px;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 12px 16px;
    border: 1.5px solid #e1e5e9;
    border-radius: 8px;
    font-size: 15px;
    color: #1a1a1a;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #667eea;
}

.anon-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
}

.anon-checkbox input[type="checkbox"] {
    width: auto;
    margin: 0;
}

.anon-checkbox label {
    font-size: 13px;
    color: #6a6a6a;
    font-weight: normal;
    margin: 0;
    cursor: pointer;
}

.interface-screen {
    display: none;
    padding: 40px;
    min-height: 100vh;
}

.interface-screen > p {
    font-size: 15px;
    color: #6a6a6a;
    text-align: center;
    margin-bottom: 30px;
}

.interface-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 30px;
}

.interface-card {
    padding: 24px;
    border: 2px solid #e1e5e9;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.interface-card:hover {
    border-color: #667eea;
    transform: translateY(-2px);
}

.interface-card.selected {
    border-color: #667eea;
    background: #f8f9ff;
}

.interface-card .icon {
    font-size: 48px;
    margin-bottom: 12px;
}

.interface-card .name {
    font-size: 16px;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 4px;
}

.interface-card .desc {
    font-size: 13px;
    color: #6a6a6a;
}

.survey-screen {
    display: none;
    flex-direction: column;
    min-height: 100vh;
}

.survey-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 16px 20px;
    position: sticky;
    top: 0;
    z-index: 100;
}

.survey-header .progress-text {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 8px;
}

.progress-bar {
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: white;
    width: 0%;
    transition: width 0.3s ease;
}

.feed {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 0;
    padding-bottom: 20px;
}

.done-button-container {
    padding: 20px;
    background: #f8f9fa;
    text-align: center;
}

.done-button {
    width: 100%;
    max-width: 400px;
    padding: 16px;
    background: linear-gradient(135deg, #51cf66, #37b24d);
    color: white;
    border: none;
    border-radius: 30px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.done-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(81, 207, 102, 0.4);
}

/* INSTAGRAM SPECIFIC */
.feed.instagram {
    background: #fafafa;
    padding: 0;
}

.instagram .post {
    background: white;
    border: none;
    border-top: 1px solid #dbdbdb;
    border-bottom: 1px solid #dbdbdb;
    margin-bottom: 16px;
}

.instagram .post-header {
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.instagram .post-avatar {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 16px;
}

.instagram .post-info {
    flex: 1;
}

.instagram .brand {
    font-size: 14px;
    font-weight: 600;
    color: #262626;
}

.instagram .time {
    font-size: 12px;
    color: #8e8e8e;
}

.instagram .post-image {
    width: 100%;
    height: 400px;
    background-size: cover;
    background-position: center;
}

.instagram .post-content {
    padding: 12px 16px;
}

.instagram .post-actions {
    display: flex;
    gap: 16px;
    padding: 12px 16px;
    border-top: 1px solid #efefef;
}

.instagram .action-btn {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    color: #262626;
    font-size: 14px;
    font-weight: 500;
}

.instagram .action-btn:disabled {
    opacity: 0.3;
}

.instagram .action-icon {
    display: flex;
    align-items: center;
}

.instagram .post-text {
    font-size: 14px;
    line-height: 18px;
    color: #262626;
    margin-bottom: 8px;
}

.instagram .post-price {
    font-size: 14px;
    font-weight: 600;
    color: #0095f6;
    margin-bottom: 8px;
}

.instagram .buy-btn-container {
    margin-left: auto;
}

.instagram .buy-btn {
    background: #0095f6;
    color: white;
    border: none;
    padding: 8px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
}

/* FACEBOOK SPECIFIC */
.feed.facebook {
    background: #f0f2f5;
    padding: 16px;
}

.facebook .post {
    background: white;
    border-radius: 8px;
    margin-bottom: 16px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

.facebook .post-header {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.facebook .post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 16px;
}

.facebook .post-info {
    flex: 1;
}

.facebook .brand {
    font-size: 15px;
    font-weight: 600;
    color: #050505;
}

.facebook .time {
    font-size: 13px;
    color: #65676b;
}

.facebook .post-image {
    width: 100%;
    height: 400px;
    background-size: cover;
    background-position: center;
}

.facebook .post-content {
    padding: 12px 16px;
}

.facebook .post-text {
    font-size: 15px;
    line-height: 1.3333;
    color: #050505;
    margin-bottom: 12px;
}

.facebook .post-price {
    font-size: 17px;
    font-weight: 600;
    color: #1877f2;
    margin-bottom: 12px;
}

.facebook .post-actions {
    display: flex;
    border-top: 1px solid #e4e6eb;
    padding: 4px 8px;
}

.facebook .action-btn {
    flex: 1;
    background: none;
    border: none;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    color: #65676b;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    border-radius: 4px;
}

.facebook .action-btn:hover:not(:disabled) {
    background: #f2f2f2;
}

.facebook .action-btn:disabled {
    opacity: 0.3;
}

.facebook .action-icon {
    display: flex;
    align-items: center;
}

.facebook .buy-btn-container {
    flex: 1;
    display: flex;
    justify-content: center;
}

.facebook .buy-btn {
    background: #1877f2;
    color: white;
    border: none;
    padding: 8px 20px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
}

/* LINKEDIN SPECIFIC */
.feed.linkedin {
    background: #f3f2ef;
    padding: 16px;
}

.linkedin .post {
    background: white;
    border: 1px solid #e0dfdc;
    border-radius: 8px;
    margin-bottom: 8px;
}

.linkedin .post-header {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.linkedin .post-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 18px;
}

.linkedin .post-info {
    flex: 1;
}

.linkedin .brand {
    font-size: 14px;
    font-weight: 600;
    color: #000000e6;
}

.linkedin .time {
    font-size: 12px;
    color: #00000099;
}

.linkedin .post-image {
    width: 100%;
    height: 400px;
    background-size: cover;
    background-position: center;
}

.linkedin .post-content {
    padding: 12px 16px;
}

.linkedin .post-text {
    font-size: 14px;
    line-height: 1.4;
    color: #000000e6;
    margin-bottom: 12px;
}

.linkedin .post-price {
    font-size: 16px;
    font-weight: 600;
    color: #0a66c2;
    margin-bottom: 12px;
}

.linkedin .post-actions {
    display: flex;
    border-top: 1px solid #e0dfdc;
    padding: 4px 8px;
}

.linkedin .action-btn {
    flex: 1;
    background: none;
    border: none;
    padding: 12px 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    color: #00000099;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border-radius: 4px;
}

.linkedin .action-btn:hover:not(:disabled) {
    background: #f3f2ef;
}

.linkedin .action-btn:disabled {
    opacity: 0.3;
}

.linkedin .action-icon {
    display: flex;
    align-items: center;
}

.linkedin .buy-btn-container {
    flex: 1;
    display: flex;
    justify-content: center;
}

.linkedin .buy-btn {
    background: #0a66c2;
    color: white;
    border: none;
    padding: 8px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 16px;
    cursor: pointer;
}

/* TIKTOK SPECIFIC */
.feed.tiktok {
    background: #000;
    padding: 0;
    scroll-snap-type: y mandatory;
    overflow-y: scroll;
}

.tiktok .post {
    height: 100vh;
    position: relative;
    background: #000;
    margin-bottom: 0;
    scroll-snap-align: start;
    scroll-snap-stop: always;
}

.tiktok .post-image {
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
}

.tiktok .post-header {
    position: absolute;
    top: 16px;
    left: 16px;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 12px;
}

.tiktok .post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 16px;
    border: 2px solid white;
}

.tiktok .post-info {
    display: flex;
    flex-direction: column;
}

.tiktok .brand {
    font-size: 15px;
    font-weight: 600;
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}

.tiktok .time {
    font-size: 12px;
    color: #d0d0d0;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}

.tiktok .post-content {
    position: absolute;
    bottom: 120px;
    left: 16px;
    right: 80px;
    color: white;
    z-index: 10;
}

.tiktok .post-text {
    font-size: 15px;
    line-height: 1.4;
    color: white;
    margin-bottom: 8px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}

.tiktok .post-text.collapsed {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.tiktok .post-text.expanded {
    display: block;
}

.tiktok .toggle-caption {
    background: none;
    border: none;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    padding: 4px 0;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}

.tiktok .post-promo {
    font-size: 14px;
    color: yellow;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
    margin-top: 8px;
}

.tiktok .post-actions {
    position: absolute;
    right: 12px;
    bottom: 140px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    z-index: 20;
}

.tiktok .action-btn {
    background: none;
    border: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    color: white;
    cursor: pointer;
    padding: 0;
}

.tiktok .action-btn:disabled {
    opacity: 0.3;
}

.tiktok .action-icon {
    width: 48px;
    height: 48px;
    background: rgba(84, 84, 84, 0.5);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.tiktok .action-btn:hover:not(:disabled) .action-icon {
    background: rgba(84, 84, 84, 0.7);
}

.tiktok .action-btn span {
    font-size: 12px;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
}

.tiktok .buy-btn {
    position: absolute;
    bottom: 80px;
    left: 16px;
    background: #fe2c55;
    color: white;
    border: none;
    padding: 12px 32px;
    font-size: 15px;
    font-weight: 700;
    border-radius: 4px;
    cursor: pointer;
    z-index: 10;
}

.results-screen {
    display: none;
    padding: 40px;
    min-height: 100vh;
    text-align: center;
}

.results-screen h2 {
    font-size: 28px;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 20px;
}

.results-box {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    text-align: left;
}

.results-box h3 {
    font-size: 18px;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 16px;
}

.results-box p {
    font-size: 15px;
    color: #4a4a4a;
    margin-bottom: 8px;
}

@media (max-width: 768px) {
    .screen {
        padding: 30px 20px;
    }
    
    .demo-screen,
    .interface-screen {
        padding: 30px 20px;
    }
    
    .interface-grid {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="screen" id="consentScreen">
        <h1>Social Media Behaviour Survey</h1>
        <p style="text-align:center;color:#4a4a4a;margin-bottom:30px;font-style:italic;line-height:1.8">"Congratulations! You've been invited to participate in research that contributes to the potentially groundbreaking understanding of what will go on to be known as The Attention-Conversion Paradox. I'd like to extend my sincerest gratitude to each and every participant. You're the best!" - Aman Vasandani, 2025</p>
        
        <h2 class="screen-subtitle">About This Research</h2>
        <p>This study examines how people interact with fashion content on different social media platforms. You'll experience realistic social feeds and can interact naturally.</p>
        
        <h2 class="screen-subtitle">What You'll Do</h2>
        <ul>
            <li>Answer a few background questions (2 minutes)</li>
            <li>Choose a social media platform style</li>
            <li>Browse through posts and interact naturally</li>
            <li><strong>Use multiple platforms?</strong> Complete the survey again for each platform you regularly use!</li>
        </ul>
        
        <h2 class="screen-subtitle">Privacy & Data Use</h2>
        <p>Your responses are anonymous and used only for academic research. No personal information is stored or shared.</p>
        
        <div class="consent-box">
            <input type="checkbox" id="consentCheck">
            <label for="consentCheck">I understand this is academic research and consent to participate. I understand my responses are anonymous and used only for research purposes.</label>
        </div>
        
        <button class="btn" id="startBtn" disabled>Start Survey</button>
    </div>

    <div class="demo-screen" id="demoScreen">
        <h2>About You</h2>
        <p>Help us understand shopping patterns across demographics</p>
        
        <div class="form-group">
            <label for="nameInput">Name</label>
            <input type="text" id="nameInput" placeholder="Your first name">
            <div class="anon-checkbox">
                <input type="checkbox" id="anonCheck">
                <label for="anonCheck">I'd like to be anonymous (generates random ID)</label>
            </div>
        </div>

        <div class="form-group">
            <label for="ageInput">Age Range</label>
            <select id="ageInput">
                <option value="">Select age range</option>
                <option value="18-24">18-24</option>
                <option value="25-29">25-29</option>
                <option value="30-34">30-34</option>
                <option value="35-39">35-39</option>
                <option value="40-44">40-44</option>
                <option value="45-50">45-50</option>
                <option value="50+">50+</option>
            </select>
        </div>

        <div class="form-group">
            <label for="countryInput">Country</label>
            <select id="countryInput">
                <option value="">Select country</option>
                <option value="AE">United Arab Emirates</option>
                <option value="SA">Saudi Arabia</option>
                <option value="IN">India</option>
                <option value="PK">Pakistan</option>
                <option value="US">United States</option>
                <option value="UK">United Kingdom</option>
                <option value="CA">Canada</option>
                <option value="AU">Australia</option>
                <option value="DE">Germany</option>
                <option value="FR">France</option>
                <option value="OTHER">Other</option>
            </select>
        </div>

        <div class="form-group">
            <label for="incomeInput">Monthly Income <span id="currLabel">(USD)</span></label>
            <select id="incomeInput">
                <option value="">Select income range</option>
            </select>
        </div>

        <div class="form-group">
            <label for="genderInput">Gender</label>
            <select id="genderInput">
                <option value="">Select gender</option>
                <option value="Female">Female</option>
                <option value="Male">Male</option>
                <option value="Non-binary">Non-binary</option>
                <option value="Prefer not to say">Prefer not to say</option>
            </select>
        </div>

        <div class="form-group">
            <label for="platformInput">Primary Social Media Platform for Fashion</label>
            <select id="platformInput">
                <option value="">Select platform</option>
                <option value="Instagram">Instagram</option>
                <option value="TikTok">TikTok</option>
                <option value="Facebook">Facebook</option>
                <option value="Pinterest">Pinterest</option>
                <option value="YouTube">YouTube</option>
                <option value="Other">Other</option>
            </select>
        </div>

        <div class="form-group">
            <label for="freqInput">How often do you shop for fashion items?</label>
            <select id="freqInput">
                <option value="">Select frequency</option>
                <option value="Daily">Daily</option>
                <option value="Weekly">Weekly</option>
                <option value="Monthly">Monthly</option>
                <option value="Quarterly">Every few months</option>
                <option value="Rarely">Rarely</option>
            </select>
        </div>

        <button class="btn" id="demoBtn" disabled>Continue to Platform Selection</button>
    </div>

    <div class="interface-screen" id="interfaceScreen">
        <h2>Choose Your Experience</h2>
        <p>Select which social media interface style you'd like to experience:</p>
        
        <div class="interface-grid">
            <div class="interface-card" data-platform="facebook">
                <div class="icon">📘</div>
                <div class="name">Facebook</div>
                <div class="desc">Detailed posts</div>
            </div>
            
            <div class="interface-card" data-platform="instagram">
                <div class="icon">📷</div>
                <div class="name">Instagram</div>
                <div class="desc">Visual-first</div>
            </div>
            
            <div class="interface-card" data-platform="linkedin">
                <div class="icon">💼</div>
                <div class="name">LinkedIn</div>
                <div class="desc">Professional</div>
            </div>
            
            <div class="interface-card" data-platform="tiktok">
                <div class="icon">🎵</div>
                <div class="name">TikTok</div>
                <div class="desc">Full-screen</div>
            </div>
        </div>
        
        <button class="btn" id="interfaceBtn" disabled>Start Experience</button>
    </div>

    <div class="survey-screen" id="surveyScreen">
        <div class="survey-header">
            <div class="progress-text">Scrolled through <span id="qNum">0</span> of <span id="qTotal">25</span> posts · Interacted with <span id="interactNum">0</span></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progFill"></div>
            </div>
        </div>
        <div class="feed" id="feed"></div>
        <div class="done-button-container">
            <button class="done-button" onclick="completeSurvey()">Complete Survey</button>
        </div>
    </div>

    <div class="results-screen" id="resultsScreen">
        <h2>Thank You!</h2>
        <div class="results-box" id="resultsBox"></div>
        <button class="btn" onclick="downloadData()" style="margin-bottom: 16px;">Download Results</button>
        <button class="btn" onclick="restartSurvey()" style="background: linear-gradient(135deg, #51cf66, #37b24d);">Take Survey Again for Another Platform</button>
    </div>
</div>

<script>
var userData = {};
var selectedPlatform = '';
var answers = [];
var postViews = [];
var startTime = Date.now();
var observer = null;
var surveySessionId = 'survey_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

var productImages = [
    'https://i.ibb.co/4nPCjLZq/Plain-T-Shirt.png',
    'https://i.ibb.co/7JwnqcGf/Eco-Sneakers.png',
    'https://i.ibb.co/qYTzhX21/Luxury-Bag.png',
    'https://i.ibb.co/5W16YtT8/White-Shirt.png',
    'https://i.ibb.co/2YkJ8rkt/Hoodie.png',
    'https://i.ibb.co/hJqHZzgY/Leggings.png',
    'https://i.ibb.co/mF49GBqb/Vintage-Jacket.png',
    'https://i.ibb.co/DHhQMpNk/Watch.png',
    'https://i.ibb.co/3mKKvcyd/Summer-Dress.png',
    'https://i.ibb.co/0RjKxKf9/Sweatshirt-Set.png',
    'https://i.ibb.co/274dVCyx/Blazer.png',
    'https://i.ibb.co/Gf4xLxtJ/Street-Sneakers.png',
    'https://i.ibb.co/rRt77DZK/Wide-Leg-Trousers.png',
    'https://i.ibb.co/00YQVty/Sunglasses.png',
    'https://i.ibb.co/HM15qm8/Trench-Coat.png',
    'https://i.ibb.co/23gT3xBp/pasta.png',
    'https://i.ibb.co/mVmBF11Y/mountain-sunrise.png',
    'https://i.ibb.co/dXCx6dN/coffee-journal-plants.png',
    'https://i.ibb.co/DPg5dHkb/envelopes-cash-categories.png',
    'https://i.ibb.co/mrymZ4wJ/reading-nook.png',
    'https://i.ibb.co/LDZnQkJW/productivity-app-interfaces.png',
    'https://i.ibb.co/ksRSMJjn/Quote-graphic.png',
    'https://i.ibb.co/MyC9WJ5g/treadmill.png',
    'https://i.ibb.co/gFbffg0h/reflecting-peacefully.png',
    'https://i.ibb.co/4nG2LBxt/vintage-film-camera.png'
];

var questions = [
    {caption: 'The perfect essential tee: soft-washed cotton, ideal drape, and crafted for longevity. Build your wardrobe foundation with quality that lasts. Always in stock.', price: 45, brand: 'Core Basics', type: 'Ad'},
    {caption: 'Step into sustainable style with the new Stride Co. "Eco-Stride". Featuring recycled materials and zero-waste construction. Lightweight comfort meets green design.', price: 89, brand: 'Stride Co.', type: 'Ad'},
    {caption: 'Maison Laurent: The "Voyager" tote. Italian leather, minimalist design, maximum utility. The only bag you need to transition seamlessly from the office to the weekend.', price: 156, brand: 'Maison Laurent', type: 'Ad'},
    {caption: 'Office Flux: Our crisp white shirt is redefined with a wrinkle-resistant stretch fabric. Look sharp, feel comfortable. A workwear essential that truly performs.', price: 67, brand: 'Office Flux', type: 'Ad'},
    {caption: 'Cozy up in our bestselling Soft Spot French Terry Hoodie. Oversized fit, premium heavyweight fabric, and the perfect shade for everyday style. Comfort, elevated.', price: 125, brand: 'Soft Spot', type: 'Ad'},
    {caption: 'Engineered for movement: AeroFit high-waisted performance leggings offer compression and breathability. Perfect for your toughest workout or your most relaxed day.', price: 78, brand: 'AeroFit', type: 'Ad'},
    {caption: 'The ultimate throwback: a genuine 90s-inspired denim jacket from The Archive. Each piece is hand-distressed for a unique, lived-in feel. Limited quantity drop.', price: 95, brand: 'The Archive', type: 'Ad'},
    {caption: 'Valenza Orologi: Precision engineering meets classic design. The "Chrono-X" timepiece features a sapphire crystal and reliable quartz movement. A timeless piece for the modern professional.', price: 189, brand: 'Valenza Orologi', type: 'Ad'},
    {caption: 'Flowy, light, and vibrant. Our linen-blend summer dress from Sundays is perfect for destination weddings or effortless daily wear. Get vacation ready.', price: 72, brand: 'Sundays', type: 'Ad'},
    {caption: 'The ultimate lounge wear set from Lounge Drop: super-soft organic cotton sweatshirt and joggers. Matching style, unmatched comfort. Your new weekend uniform.', price: 85, brand: 'Lounge Drop', type: 'Ad'},
    {caption: 'Struktura Atelier: The unstructured wool-blend blazer. Tailored for comfort, styled for versatility. The modern interpretation of professional attire.', price: 145, brand: 'Struktura Atelier', type: 'Ad'},
    {caption: 'Built for speed, styled for the street. Our new Rush Runner sneakers offer responsive cushioning and a striking silhouette. Available in three colorways.', price: 110, brand: 'Rush Runner', type: 'Ad'},
    {caption: 'Vogue Élan: The ultimate versatile pant: wide-leg trousers in a breathable linen blend. Effortlessly polished for the office or a chic weekend.', price: 99, brand: 'Vogue Élan', type: 'Ad'},
    {caption: 'Classic geometry, modern feel. Optic Haze polarized sunglasses offer 100% UV protection and a universally flattering fit. Essential summer clarity.', price: 65, brand: 'Optic Haze', type: 'Ad'},
    {caption: 'Porte-Vent: The iconic trench, redefined. Water-resistant, perfectly structured, and ready for transitional weather. An investment piece that lasts decades.', price: 210, brand: 'Porte-Vent', type: 'Ad'},
    {caption: 'Viral Recipe Alert! Stop ordering takeout and make this 15-minute creamy lemon pasta. It uses 5 ingredients and tastes like a Michelin star! Recipe in comments.', caption_li: 'The Efficiency Mindset: Applying the "15-Minute Rule" to your workday. If a task can be done in less time than it takes to order lunch, do it immediately. What\'s your professional "5-Ingredient" solution?', price: 0, brand: 'The Home Chef', type: 'Content'},
    {caption: 'Is this the best sunrise spot in the world? Found absolute peace in the Swiss Alps this morning. Sometimes you just need to disconnect to truly recharge. Where are you heading next?', caption_li: 'The ROI of Sabbaticals: Exploring why leading companies are encouraging genuine time off. A well-rested team isn\'t just happier; they\'re 40% more innovative. Prioritize rest, not just recovery.', price: 0, brand: 'Travel Digest', type: 'Content'},
    {caption: 'My morning routine is finally non-negotiable. Started the day with 10 mins of stretching and journaling. It\'s not about perfection, it\'s about consistency. What\'s one small habit that changed your life?', caption_li: 'The Power of the First Hour: Your career momentum starts before 9 AM. If you\'re reactive from the moment you wake up, you\'ve already lost control of the day. Share your most impactful non-work morning ritual.', price: 0, brand: 'Simply Living', type: 'Content'},
    {caption: 'A simple budgeting trick that changed my life: The 50/30/20 rule is out. I use the 4-Envelope System. Seriously, try it for 30 days. You\'ll be shocked how much you save! Link in bio for the template.', caption_li: 'The Budgeting Myth: Why cutting costs isn\'t growth. We discuss shifting your focus from expense reduction (envelope systems) to revenue expansion and strategic investment. What\'s your biggest Q4 investment priority?', price: 0, brand: 'Wealth Builder', type: 'Content'},
    {caption: 'Small space, HUGE impact. Just finished decorating this tiny corner of my apartment using only thrifted finds. Don\'t be afraid to mix vintage pieces with modern design! What\'s your favorite thrift find?', caption_li: 'Operational Excellence in a Small Business: How highly efficient startups treat their physical (or digital) "space" like a minimal, well-designed asset. Maximizing output with minimal overhead is the ultimate design challenge.', price: 0, brand: 'Aesthetic Living', type: 'Content'},
    {caption: '3 apps that make me feel like I have an assistant. If you\'re still using your phone\'s default notes app, you\'re missing out. App #2 is a game-changer for digital organization. Are you a paper planner or fully digital?', caption_li: 'Tool Stack Strategy: In 2024, your tool stack IS your competitive advantage. We review the essential low-cost SaaS solutions that deliver enterprise-grade efficiency for small teams. What\'s the one tool you couldn\'t live without?', price: 0, brand: 'Future Office', type: 'Content'},
    {caption: 'Reminder: Failure is data, not destiny. Every setback I\'ve had led to a pivot that made the next success bigger. Drop a comment if you needed to hear this today!', caption_li: 'Navigating the Post-Mortem: Successful leaders don\'t fear failure; they standardize the review process. A clear, non-punitive post-mortem is the fastest path to iteration. Share a lesson from a professional setback.', price: 0, brand: 'Success Path', type: 'Content'},
    {caption: 'Trying the 12-3-30 trend! It sounds easier than it is, but it\'s a killer cardio routine. 12% incline, 3 mph, 30 minutes. Tag a friend to try it with you!', caption_li: 'The Stamina Gap: The correlation between physical fitness and executive decision-making stamina is undeniable. Investing in corporate wellness is not a perk; it\'s a strategic investment in peak performance hours. How does your company support wellness?', price: 0, brand: 'Active Life', type: 'Content'},
    {caption: 'How to set boundaries without feeling guilty. It took me years to realize that "no" is a complete sentence. Your energy is your most valuable asset. Who needs to hear this?', caption_li: 'The Art of the Professional "No": Learning to decline non-strategic requests is essential for preserving bandwidth for high-impact projects. It\'s not about being unhelpful; it\'s about being focused. How do you protect your time?', price: 0, brand: 'Mindful Living', type: 'Content'},
    {caption: 'My new obsession: Film Photography. There\'s something so satisfying about slowing down and waiting for the results. It forces you to be intentional. What hobby are you learning this month?', caption_li: 'The Creative Drain in Corporate Life: We need "intentional downtime" to foster the lateral thinking that solves complex problems. Are you allowing your team true mental breaks, or just packing the schedule?', price: 0, brand: 'Creative Pursuit', type: 'Content'}
];

for (var i = 0; i < questions.length; i++) {
    postViews[i] = {
        viewed: false,
        viewStartTime: null,
        totalViewTime: 0,
        interacted: false
    };
}

window.addEventListener('beforeunload', function(e) {
    savePartialData();
});

function savePartialData() {
    if (answers.length > 0 || postViews.some(function(pv) { return pv.viewed; })) {
        var now = Date.now();
        postViews.forEach(function(pv) {
            if (pv.viewStartTime) {
                var viewDuration = now - pv.viewStartTime;
                pv.totalViewTime += viewDuration;
            }
        });
        
        var partialData = {
            sessionId: surveySessionId,
            demographics: userData,
            platform: selectedPlatform,
            answers: answers,
            postViews: postViews,
            totalTime_ms: now - startTime,
            timestamp: new Date().toISOString(),
            completed: false
        };
        
        try {
            navigator.sendBeacon('YOUR_GOOGLE_SCRIPT_URL_HERE', JSON.stringify(partialData));
        } catch(err) {
            console.log('Partial data save failed');
        }
    }
}

function getAvatarColor(brandName) {
    var hash = 0;
    for (var i = 0; i < brandName.length; i++) {
        hash = brandName.charCodeAt(i) + ((hash << 5) - hash);
    }
    var color = '#';
    for (var i = 0; i < 3; i++) {
        var value = (hash >> (i * 8)) & 0xFF;
        color += ('00' + value.toString(16)).substr(-2);
    }
    var r = parseInt(color.slice(1, 3), 16);
    var g = parseInt(color.slice(3, 5), 16);
    var b = parseInt(color.slice(5, 7), 16);
    var factor = 0.7;
    var finalR = Math.min(255, Math.floor(r * factor + 80));
    var finalG = Math.min(255, Math.floor(g * factor + 80));
    var finalB = Math.min(255, Math.floor(b * factor + 80));
    return '#' + [finalR, finalG, finalB].map(function(c) { return c.toString(16).padStart(2, '0'); }).join('');
}

var icons = {
    like: {
        instagram: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>',
        facebook: '<svg fill="currentColor" viewBox="0 0 24 24" width="20" height="20"><path d="M13.11 5.34L11.75 6.7l1.46 1.46L11 9.41V19c0 1.1.9 2 2 2h6c.83 0 1.5-.67 1.5-1.5V10c0-.55-.45-1-1-1h-4.34l.87-3.96c.08-.43-.1-.85-.43-1.07-.33-.22-.76-.14-1.01.21L13.11 5.34zM5 10H3v11h2V10z"/></svg>',
        linkedin: '<svg fill="currentColor" viewBox="0 0 24 24" width="20" height="20"><path d="M1 21h4V9H1v12zm2-17a4 4 0 100 8A4 4 0 003 4zm6 9h12v2H9v-2zm0-4h12v2H9V9zm0-4h12v2H9V5z"/></svg>',
        tiktok: '<svg fill="currentColor" viewBox="0 0 48 48" width="32" height="32"><path d="M34.6 6.1c-1.6 0-2.9 1.3-2.9 2.9v20.3c0 6.4-5.2 11.6-11.6 11.6s-11.6-5.2-11.6-11.6 5.2-11.6 11.6-11.6c.3 0 .7 0 1 .1v-5.2c-.3 0-.7-.1-1-.1-9.2 0-16.7 7.5-16.7 16.7S10.9 46 20.1 46s16.7-7.5 16.7-16.7V15.8c2.6 1.9 5.8 3 9.2 3V13.6c-5.8 0-10.5-4.7-10.5-10.5h-5.1z"/></svg>'
    },
    comment: {
        instagram: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>',
        facebook: '<svg fill="currentColor" viewBox="0 0 24 24" width="20" height="20"><path d="M21 12c0-4.418-4.03-8-9-8s-9 3.582-9 8c0 2.21.9 4.21 2.34 5.75L3 20l3.72-1.39C7.51 19.04 9.07 19.5 11 19.5h1c4.97 0 9-3.582 9-8z"/></svg>',
        linkedin: '<svg fill="currentColor" viewBox="0 0 24 24" width="20" height="20"><path d="M21 12c0-4.418-4.03-8-9-8s-9 3.582-9 8c0 2.21.9 4.21 2.34 5.75L3 20l3.72-1.39C7.51 19.04 9.07 19.5 11 19.5h1c4.97 0 9-3.582 9-8z"/></svg>',
        tiktok: '<svg fill="currentColor" viewBox="0 0 48 48" width="32" height="32"><path d="M41 7H7c-2.21 0-4 1.79-4 4v20c0 2.21 1.79 4 4 4h26l8 8V11c0-2.21-1.79-4-4-4z"/></svg>'
    },
    share: {
        instagram: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>',
        facebook: '<svg fill="currentColor" viewBox="0 0 24 24" width="20" height="20"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>',
        linkedin: '<svg fill="currentColor" viewBox="0 0 24 24" width="20" height="20"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 6h16l-8 5.5L4 6zm0 12V8.5l8 5.5 8-5.5V18H4z"/></svg>',
        tiktok: '<svg fill="currentColor" viewBox="0 0 48 48" width="32" height="32"><path d="M36 20v-4c-3.31 0-6-2.69-6-6h-4v20c0 3.31-2.69 6-6 6s-6-2.69-6-6 2.69-6 6-6v-4c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10V16c2.48 1.53 5.39 2.44 8.5 2.44z"/></svg>'
    }
};

document.getElementById('consentCheck').addEventListener('change', function() {
    document.getElementById('startBtn').disabled = !this.checked;
});

document.getElementById('startBtn').addEventListener('click', function() {
    document.getElementById('consentScreen').style.display = 'none';
    document.getElementById('demoScreen').style.display = 'block';
});

var demoFields = ['nameInput', 'ageInput', 'countryInput', 'incomeInput', 'genderInput', 'platformInput', 'freqInput'];

demoFields.forEach(function(id) {
    var el = document.getElementById(id);
    el.addEventListener('change', validateDemo);
    el.addEventListener('input', validateDemo);
});

function validateDemo() {
    var filled = demoFields.every(function(id) {
        return document.getElementById(id).value.trim() !== '';
    });
    document.getElementById('demoBtn').disabled = !filled;
}

document.getElementById('anonCheck').addEventListener('change', function() {
    var nameInput = document.getElementById('nameInput');
    if (this.checked) {
        var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        var id = 'ANON';
        for (var i = 0; i < 8; i++) {
            id += chars[Math.floor(Math.random() * chars.length)];
        }
        nameInput.value = id;
        nameInput.readOnly = true;
    } else {
        nameInput.value = '';
        nameInput.readOnly = false;
    }
    validateDemo();
});

document.getElementById('countryInput').addEventListener('change', function() {
    var country = this.value;
    var label = document.getElementById('currLabel');
    var select = document.getElementById('incomeInput');
    
    select.innerHTML = '<option value="">Select income range</option>';
    
    var currData = {
        'AE': {curr: 'AED', ranges: ['Under 3,000', '3,000-5,000', '5,000-8,000', '8,000-12,000', '12,000-18,000', 'Over 18,000']},
        'SA': {curr: 'SAR', ranges: ['Under 3,000', '3,000-5,000', '5,000-8,000', '8,000-12,000', '12,000-18,000', 'Over 18,000']},
        'IN': {curr: 'INR', ranges: ['Under 25,000', '25,000-50,000', '50,000-75,000', '75,000-100,000', '100,000-150,000', 'Over 150,000']},
        'PK': {curr: 'PKR', ranges: ['Under 50,000', '50,000-75,000', '75,000-100,000', '100,000-150,000', '150,000-200,000', 'Over 200,000']},
        'UK': {curr: 'GBP', ranges: ['Under 2,000', '2,000-3,000', '3,000-4,000', '4,000-5,000', '5,000-7,000', 'Over 7,000']},
        'CA': {curr: 'CAD', ranges: ['Under 2,500', '2,500-4,000', '4,000-5,500', '5,500-7,000', '7,000-9,000', 'Over 9,000']},
        'AU': {curr: 'AUD', ranges: ['Under 2,500', '2,500-4,000', '4,000-5,500', '5,500-7,000', '7,000-9,000', 'Over 9,000']},
        'DE': {curr: 'EUR', ranges: ['Under 2,000', '2,000-3,000', '3,000-4,000', '4,000-5,000', '5,000-7,000', 'Over 7,000']},
        'FR': {curr: 'EUR', ranges: ['Under 2,000', '2,000-3,000', '3,000-4,000', '4,000-5,000', '5,000-7,000', 'Over 7,000']}
    };
    
    var info = currData[country] || {curr: 'USD', ranges: ['Under 2,000', '2,000-3,500', '3,500-5,000', '5,000-7,000', '7,000-10,000', 'Over 10,000']};
    label.textContent = '(' + info.curr + ')';
    
    info.ranges.forEach(function(r) {
        var opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        select.appendChild(opt);
    });
});

document.getElementById('demoBtn').addEventListener('click', function() {
    userData = {
        name: document.getElementById('nameInput').value,
        age: document.getElementById('ageInput').value,
        country: document.getElementById('countryInput').value,
        income: document.getElementById('incomeInput').value,
        gender: document.getElementById('genderInput').value,
        platform: document.getElementById('platformInput').value,
        frequency: document.getElementById('freqInput').value,
        anonymous: document.getElementById('anonCheck').checked
    };
    
    document.getElementById('demoScreen').style.display = 'none';
    document.getElementById('interfaceScreen').style.display = 'block';
});

document.querySelectorAll('.interface-card').forEach(function(card) {
    card.addEventListener('click', function() {
        document.querySelectorAll('.interface-card').forEach(function(c) {
            c.classList.remove('selected');
        });
        this.classList.add('selected');
        selectedPlatform = this.dataset.platform;
        document.getElementById('interfaceBtn').disabled = false;
    });
});

document.getElementById('interfaceBtn').addEventListener('click', function() {
    document.getElementById('interfaceScreen').style.display = 'none';
    document.getElementById('surveyScreen').style.display = 'flex';
    initSurvey();
});

function getPriceForCountry(usd, country) {
    var rates = {
        'AE': {r: 3.67, s: 'AED', after: true}, 'SA': {r: 3.75, s: 'SAR', after: true},
        'IN': {r: 83, s: '₹', after: false}, 'PK': {r: 280, s: 'PKR', after: true},
        'US': {r: 1, s: '$', after: false}, 'UK': {r: 0.79, s: '£', after: false},
        'CA': {r: 1.35, s: 'CAD $', after: false}, 'AU': {r: 1.50, s: 'AUD $', after: false},
        'DE': {r: 0.92, s: '€', after: false}, 'FR': {r: 0.92, s: '€', after: false}
    };
    var info = rates[country] || rates['US'];
    var amt = Math.round(usd * info.r);
    return usd > 0 ? (info.after ? (amt + ' ' + info.s) : (info.s + amt)) : '';
}

function toggleTikTokCaption(captionId) {
    var caption = document.getElementById(captionId);
    var button = document.getElementById(captionId + '-btn');
    
    if (caption.classList.contains('collapsed')) {
        caption.classList.remove('collapsed');
        caption.classList.add('expanded');
        button.textContent = 'Show less';
    } else {
        caption.classList.add('collapsed');
        caption.classList.remove('expanded');
        button.textContent = '...more';
    }
}

function initSurvey() {
    var feed = document.getElementById('feed');
    feed.innerHTML = '';
    feed.className = 'feed ' + selectedPlatform;
    
    document.getElementById('qTotal').textContent = questions.length;
    
    var indices = Array.from({length: questions.length}, function(_, i) { return i; });
    
    for (var i = indices.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = indices[i];
        indices[i] = indices[j];
        indices[j] = temp;
    }
    
    indices.forEach(function(idx) {
        var q = questions[idx];
        var isAd = q.type === 'Ad';
        var isLinkedIn = selectedPlatform === 'linkedin';
        var isTextOnly = isLinkedIn && (idx === 17 || idx === 21);
        
        var price = isAd ? getPriceForCountry(q.price, userData.country) : '';
        var brandName = q.brand;
        var caption = isLinkedIn && q.caption_li ? q.caption_li : q.caption;
        var imagePath = productImages[idx];
        
        var post = document.createElement('div');
        post.className = 'post';
        post.dataset.index = idx;
        
        var avatarColor = getAvatarColor(brandName);
        var avatarInitial = brandName.charAt(0);
        
        var buyBtnHTML = isAd ? '<button class="buy-btn" onclick="answer(' + idx + ', ' + "'buy'" + ')">Shop Now</button>' : '';
        
        var actionsHTML = '';
        var headerHTML = '';
        var imageHTML = '';
        var contentHTML = '';
        
        if (selectedPlatform !== 'tiktok') {
            var sponsoredTag = isAd && (selectedPlatform === 'facebook' || selectedPlatform === 'linkedin') ? ' <span style="font-weight: normal; color: #606770;">· Sponsored</span>' : '';
            headerHTML = '<div class="post-header"><div class="post-avatar" style="background-color: ' + avatarColor + ';">' + avatarInitial + '</div><div class="post-info"><div class="brand">' + brandName + sponsoredTag + '</div><div class="time">2h ago</div></div></div>';
        }
        
        if (!isTextOnly) {
            imageHTML = '<div class="post-image" style="background-image: url(' + "'" + imagePath + "'" + ');"></div>';
        }
        
        if (isTextOnly) {
            contentHTML = '<div class="post-content" style="padding: 24px;"><div class="post-text" style="font-size: 15px; line-height: 1.6;">' + caption + '</div></div>';
        } else {
            contentHTML = '<div class="post-content"><div class="post-text"><strong>' + brandName + '</strong> ' + caption + '</div>' + (isAd ? '<div class="post-price">' + price + '</div>' : '') + '</div>';
        }
        
        if (selectedPlatform === 'tiktok') {
            var tiktokHandle = '@' + brandName.toLowerCase().replace(/ /g, '');
            var captionId = 'tiktok-caption-' + idx;
            var toggleBtnId = captionId + '-btn';
            
            headerHTML = '<div class="post-header"><div class="post-avatar" style="background-color: ' + avatarColor + ';"></div><div class="post-info"><div class="brand">' + tiktokHandle + '</div><div class="time">' + (isAd ? 'Sponsored' : 'For You') + '</div></div></div>';
            
            actionsHTML = '<div class="post-actions">' +
                '<button class="action-btn" onclick="answer(' + idx + ', ' + "'like'" + ')"><div class="action-icon">' + icons.like.tiktok + '</div><span>Like</span></button>' +
                '<button class="action-btn" onclick="answer(' + idx + ', ' + "'comment'" + ')"><div class="action-icon">' + icons.comment.tiktok + '</div><span>Comment</span></button>' +
                '<button class="action-btn" onclick="answer(' + idx + ', ' + "'share'" + ')"><div class="action-icon">' + icons.share.tiktok + '</div><span>Share</span></button>' +
                '</div>' +
                (isAd ? '<div style="position: absolute; bottom: 80px; left: 16px; z-index: 10;">' + buyBtnHTML + '</div>' : '');
            
            post.innerHTML = imageHTML +
                '<div class="post-content"><div class="post-text collapsed" id="' + captionId + '">' + tiktokHandle + ' ' + caption + '</div>' +
                '<button class="toggle-caption" id="' + toggleBtnId + '" onclick="toggleTikTokCaption(' + "'" + captionId + "'" + ')">...more</button>' +
                (isAd ? '<div class="post-promo">' + price + ' • Shop Now</div>' : '') +
                '</div>' +
                actionsHTML +
                headerHTML;
        } else {
            actionsHTML = '<div class="post-actions">' +
                '<button class="action-btn" onclick="answer(' + idx + ', ' + "'like'" + ')"><span class="action-icon">' + icons.like[selectedPlatform] + '</span><span>Like</span></button>' +
                '<button class="action-btn" onclick="answer(' + idx + ', ' + "'comment'" + ')"><span class="action-icon">' + icons.comment[selectedPlatform] + '</span><span>Comment</span></button>' +
                '<button class="action-btn" onclick="answer(' + idx + ', ' + "'share'" + ')"><span class="action-icon">' + icons.share[selectedPlatform] + '</span><span>Share</span></button>' +
                (isAd ? '<div class="buy-btn-container">' + buyBtnHTML + '</div>' : '') +
                '</div>';
            
            post.innerHTML = headerHTML + imageHTML + contentHTML + actionsHTML;
        }
        
        feed.appendChild(post);
    });
    
    setupViewTracking();
}

function setupViewTracking() {
    var options = {
        root: null,
        rootMargin: '0px',
        threshold: 0.5
    };
    
    observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
            var idx = parseInt(entry.target.dataset.index);
            var now = Date.now();
            
            if (entry.isIntersecting) {
                if (!postViews[idx].viewed) {
                    postViews[idx].viewed = true;
                }
                postViews[idx].viewStartTime = now;
            } else {
                if (postViews[idx].viewStartTime) {
                    var viewDuration = now - postViews[idx].viewStartTime;
                    postViews[idx].totalViewTime += viewDuration;
                    postViews[idx].viewStartTime = null;
                }
            }
            
            updateProgress();
        });
    }, options);
    
    document.querySelectorAll('.post').forEach(function(post) {
        observer.observe(post);
    });
}

function answer(idx, choice) {
    var now = Date.now();
    var post = document.querySelector('[data-index="' + idx + '"]');

    if (!answers.some(function(a) { return a.question_index === idx; })) {
        postViews[idx].interacted = true;
        
        if (postViews[idx].viewStartTime) {
            var viewDuration = now - postViews[idx].viewStartTime;
            postViews[idx].totalViewTime += viewDuration;
            postViews[idx].viewStartTime = now;
        }
        
        answers.push({
            question_index: idx,
            platform: selectedPlatform,
            action: choice,
            time_ms: now - startTime,
            view_time_ms: postViews[idx].totalViewTime,
            post_type: questions[idx].type,
            brand: questions[idx].brand
        });
        
        var btns = post.querySelectorAll('.action-btn, .buy-btn');
        btns.forEach(function(b) { b.disabled = true; });

        updateProgress();
    }
}

function updateProgress() {
    var viewedCount = postViews.filter(function(pv) { return pv.viewed; }).length;
    var interactedCount = answers.length;
    var total = questions.length;
    var pct = (viewedCount / total) * 100;
    document.getElementById('qNum').textContent = viewedCount;
    document.getElementById('interactNum').textContent = interactedCount;
    document.getElementById('progFill').style.width = pct + '%';
}

function completeSurvey() {
    if (observer) {
        observer.disconnect();
    }
    
    var now = Date.now();
    postViews.forEach(function(pv) {
        if (pv.viewStartTime) {
            var viewDuration = now - pv.viewStartTime;
            pv.totalViewTime += viewDuration;
            pv.viewStartTime = null;
        }
    });
    
    showResults();
}

function showResults() {
    document.getElementById('surveyScreen').style.display = 'none';
    document.getElementById('resultsScreen').style.display = 'block';
    
    var totalTime = Math.floor((Date.now() - startTime) / 1000);
    var interactedCount = answers.length;
    var viewedButNotInteracted = postViews.filter(function(pv) {
        return pv.viewed && !pv.interacted;
    }).length;
    var totalViewed = postViews.filter(function(pv) { return pv.viewed; }).length;
    
    var adInteractions = answers.filter(function(a) { return questions[a.question_index].type === 'Ad'; }).length;
    var contentInteractions = answers.filter(function(a) { return questions[a.question_index].type === 'Content'; }).length;
    
    var totalResponseTime = answers.reduce(function(sum, a) { return sum + a.time_ms; }, 0);
    var avgTime = interactedCount > 0 ? totalResponseTime / interactedCount / 1000 : 0;
    
    var totalViewTime = postViews.reduce(function(sum, pv) {
        return pv.viewed ? sum + pv.totalViewTime : sum;
    }, 0);
    var avgViewTime = totalViewed > 0 ? totalViewTime / totalViewed / 1000 : 0;
    
    document.getElementById('resultsBox').innerHTML = '<h3>Survey Complete!</h3><p><strong>Platform:</strong> ' + selectedPlatform.charAt(0).toUpperCase() + selectedPlatform.slice(1) + '</p><p><strong>Posts Viewed:</strong> ' + totalViewed + ' of ' + questions.length + '</p><p><strong>Posts Interacted With:</strong> ' + interactedCount + ' (' + adInteractions + ' ads, ' + contentInteractions + ' content)</p><p><strong>Posts Scrolled Past:</strong> ' + viewedButNotInteracted + '</p><p><strong>Total Time:</strong> ' + Math.floor(totalTime / 60) + ':' + String(totalTime % 60).padStart(2, '0') + '</p><p><strong>Average View Time:</strong> ' + avgViewTime.toFixed(1) + 's per post</p><p><strong>Average Interaction Time:</strong> ' + (interactedCount > 0 ? avgTime.toFixed(1) : 'N/A') + 's</p><p style="margin-top:16px;font-style:italic;">Thank you for contributing to fashion retail research!</p>';
}

function downloadData() {
    var data = {
        sessionId: surveySessionId,
        demographics: userData,
        platform: selectedPlatform,
        answers: answers,
        postViews: postViews,
        totalTime_ms: Date.now() - startTime,
        timestamp: new Date().toISOString(),
        completed: true
    };
    
    fetch('YOUR_GOOGLE_SCRIPT_URL_HERE', {
        method: 'POST',
        mode: 'no-cors',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).catch(function(err) {
        console.log('Upload expected to fail without Google Script URL');
    });
    
    var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'survey-' + userData.name.substring(0,4) + '-' + selectedPlatform + '-' + Date.now() + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function restartSurvey() {
    userData = {};
    selectedPlatform = '';
    answers = [];
    startTime = Date.now();
    surveySessionId = 'survey_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    for (var i = 0; i < questions.length; i++) {
        postViews[i] = {
            viewed: false,
            viewStartTime: null,
            totalViewTime: 0,
            interacted: false
        };
    }
    
    if (observer) {
        observer.disconnect();
        observer = null;
    }
    
    document.getElementById('consentCheck').checked = false;
    document.getElementById('startBtn').disabled = true;
    document.getElementById('nameInput').value = '';
    document.getElementById('nameInput').readOnly = false;
    document.getElementById('anonCheck').checked = false;
    document.getElementById('ageInput').value = '';
    document.getElementById('countryInput').value = '';
    document.getElementById('incomeInput').innerHTML = '<option value="">Select income range</option>';
    document.getElementById('currLabel').textContent = '(USD)';
    document.getElementById('genderInput').value = '';
    document.getElementById('platformInput').value = '';
    document.getElementById('freqInput').value = '';
    document.getElementById('demoBtn').disabled = true;
    
    document.querySelectorAll('.interface-card').forEach(function(c) {
        c.classList.remove('selected');
    });
    document.getElementById('interfaceBtn').disabled = true;
    
    document.getElementById('consentScreen').style.display = 'block';
    document.getElementById('demoScreen').style.display = 'none';
    document.getElementById('interfaceScreen').style.display = 'none';
    document.getElementById('surveyScreen').style.display = 'none';
    document.getElementById('resultsScreen').style.display = 'none';
    
    window.scrollTo(0, 0);
}
</script>
</body>
</html>
