<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Media Behaviour Survey</title>
<style>
/* ---------------------------------------------------- */
/* --- 1. Base Styles (UNTOUCHED INITIAL FORMAT) --- */
/* ---------------------------------------------------- */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    overflow-x: hidden;
}

.container {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    min-height: 100vh;
}

.screen {
    padding: 60px 40px;
    min-height: 100vh;
}

.screen h1 {
    font-size: 32px;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 30px;
    text-align: center;
}

.screen h2 {
    font-size: 28px;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 10px;
    text-align: center;
}

.screen-subtitle {
    font-size: 20px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 25px 0 15px 0;
}

.screen p {
    font-size: 16px;
    line-height: 1.6;
    color: #4a4a4a;
    margin-bottom: 15px;
}

.screen ul {
    margin-left: 20px;
    margin-bottom: 20px;
}

.screen li {
    margin-bottom: 8px;
    font-size: 16px;
    color: #4a4a4a;
}

.consent-box {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin: 30px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.consent-box input[type="checkbox"] {
    margin-top: 3px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.consent-box label {
    font-size: 15px;
    line-height: 1.5;
    color: #4a4a4a;
    cursor: pointer;
}

.btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 30px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
}

.btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.demo-screen {
    display: none;
    padding: 40px;
    min-height: 100vh;
}

.demo-screen > p {
    font-size: 15px;
    color: #6a6a6a;
    text-align: center;
    margin-bottom: 30px;
}

.form-group {
    margin-bottom: 24px;
}

.form-group label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: #1a1a1a;
    margin-bottom: 8px;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 12px 16px;
    border: 1.5px solid #e1e5e9;
    border-radius: 8px;
    font-size: 15px;
    color: #1a1a1a;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #667eea;
}

.interface-screen {
    display: none;
    padding: 40px;
    min-height: 100vh;
}

.interface-screen > p {
    font-size: 15px;
    color: #6a6a6a;
    text-align: center;
    margin-bottom: 30px;
}

.interface-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 30px;
}

.interface-card {
    padding: 24px;
    border: 2px solid #e1e5e9;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.interface-card:hover {
    border-color: #667eea;
    transform: translateY(-2px);
}

.interface-card.selected {
    border-color: #667eea;
    background: #f8f9ff;
}

.interface-card .icon {
    font-size: 48px;
    margin-bottom: 12px;
}

.interface-card .name {
    font-size: 16px;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 4px;
}

.interface-card .desc {
    font-size: 13px;
    color: #6a6a6a;
}

.survey-screen {
    display: none;
    flex-direction: column;
    min-height: 100vh;
    overflow: hidden; 
}

.survey-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 16px 20px;
    position: sticky;
    top: 0;
    z-index: 100;
    flex-shrink: 0;
}

.survey-header .progress-text {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 8px;
}

.progress-bar {
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: white;
    width: 0%;
    transition: width 0.3s ease;
}

/* ---------------------------------------------------- */
/* --- 2. Enhanced Platform-Specific CSS (HYBRID SCROLL) --- */
/* ---------------------------------------------------- */

/* Base Feed Styling */
.feed {
    flex: 1;
    -webkit-overflow-scrolling: touch;
    padding: 0;
    background: #f8f9fa; 
    /* Default scroll for FB/IG/LI */
    overflow-y: scroll;
    height: calc(100vh - 54px); 
    scroll-snap-type: none; /* Default: No snap */
}

/* TikTok Feed: Overrides for swipe/snap experience */
.feed.tiktok {
    background: #000;
    scroll-snap-type: y mandatory; /* Enable snapping for TikTok */
    overflow-y: scroll;
}

/* --- Post Card Styling --- */
.post {
    background: white;
    border-radius: 0;
    margin-bottom: 0;
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
    width: 100%;
    height: auto; /* Default: Auto height for continuous scroll */
    flex-shrink: 0;
    margin-bottom: 12px; /* Add margin back for continuous scroll separation */
}

/* TikTok Post: Forced full-screen height and snap */
.tiktok .post {
    background: #000;
    justify-content: flex-end;
    height: calc(100vh - 54px); 
    scroll-snap-align: start;
    margin-bottom: 0;
}

/* Instagram Post */
.instagram .post {
    border: 1px solid #dbdbdb;
    margin-bottom: 24px;
}

/* Facebook Post */
.facebook .post {
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    margin: 12px auto;
    max-width: 580px;
    height: auto; 
    display: block; 
}

/* LinkedIn Post */
.linkedin .post {
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    margin: 8px auto;
    max-width: 580px;
    height: auto; 
    display: block;
}


/* --- Post Header (Avatar/Brand Name) --- */
.post-header {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 2;
}

.tiktok .post-header {
    position: absolute;
    bottom: 50px; 
    width: 80%;
    padding: 0 16px 8px;
    color: white;
    order: 3;
}

.post-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #dcdcdc;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #4a4a4a;
    font-weight: 700;
    font-size: 16px;
    flex-shrink: 0;
}

.instagram .post-avatar {
    border: 2px solid #c13584; 
    background: white;
    color: #c13584;
}

/* --- Post Image/Video --- */
.post-image {
    width: 100%;
    height: 300px;
    background-size: cover;
    background-position: center;
    position: relative;
    background-color: #eee;
    flex-grow: 1; 
}

.facebook .post-image, 
.linkedin .post-image {
    height: 400px; /* Make images a bit taller on desktop-style feeds */
}

.tiktok .post-image {
    height: 100%; 
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    box-shadow: inset 0 -100px 50px -50px rgba(0,0,0,0.8);
    flex-grow: 0;
}


/* --- Post Content, Actions, CTA (Styling remains the same, adjusted for layout) --- */
.post-content {
    padding: 12px 16px;
    position: relative;
    z-index: 2;
}
.tiktok .post-content {
    position: absolute;
    bottom: 90px; 
    left: 0;
    width: 80%;
}

.post-actions {
    display: flex;
    gap: 16px;
    padding: 8px 16px;
    border-top: 1px solid #efefef;
    position: relative;
    z-index: 2;
    flex-shrink: 0;
}

.tiktok .post-actions {
    position: absolute;
    right: 12px;
    bottom: 140px;
    flex-direction: column;
    gap: 20px;
    border: none;
    padding: 0;
    order: 1; 
}

.ad-cta-block {
    padding: 0 16px 16px;
    background: white;
    border-top: 1px solid #e4e6eb;
    flex-shrink: 0;
}

/* Hide action bar BUY button, except on IG/TT where it lives inside the bar/stack */
.post-actions .buy-btn {
    display: none;
}
.instagram .post-actions .buy-btn,
.tiktok .post-actions .buy-btn {
    display: flex; 
}

/* Hide the entire CTA block for non-FB/LI posts */
.instagram .ad-cta-block,
.tiktok .ad-cta-block {
    display: none;
}


@media (max-width: 768px) {
    .screen {
        padding: 30px 20px;
    }
    
    .demo-screen,
    .interface-screen {
        padding: 30px 20px;
    }
    
    .interface-grid {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>

<div class="container">

    <div id="consentScreen" class="screen">
        <h1>Welcome to the Survey</h1>
        <p>This is a study on social media shopping behavior. You will be asked to browse a simulated feed and interact with fashion-related posts.</p>
        <p>Your participation is voluntary and all data will be analyzed anonymously unless you choose to provide demographic data.</p>
        
        <div class="screen-subtitle">Instructions:</div>
        <ul>
            <li>You will see a mixture of **commercial (ad)** and **non-commercial (organic)** content on a single social media platform.</li>
            <li>For posts you are interested in, you can choose to **Like**, **Comment**, **Share**, or **Buy Now** (for ads).</li>
            <li>**The time you take to respond to a post you interact with will be recorded.**</li>
            <li>You may scroll past any post without interacting.</li>
        </ul>
        
        <div class="consent-box">
            <input type="checkbox" id="consentCheckbox" onchange="document.getElementById('startDemoBtn').disabled = !this.checked">
            <label for="consentCheckbox">I have read the information above and consent to participate in this study.</label>
        </div>
        
        <button id="startDemoBtn" class="btn" onclick="showScreen('demoScreen')" disabled>Start</button>
    </div>
    
    <div id="demoScreen" class="demo-screen">
        <h2>Demographic Information</h2>
        <p>Please provide the following information. This data helps us analyze responses across different user groups.</p>
        
        <div class="form-group">
            <label for="age">Age</label>
            <input type="number" id="age" min="18" placeholder="e.g., 25" required>
        </div>
        
        <div class="form-group">
            <label for="gender">Gender</label>
            <select id="gender" required>
                <option value="" disabled selected>Select...</option>
                <option value="female">Female</option>
                <option value="male">Male</option>
                <option value="nonbinary">Non-binary</option>
                <option value="prefer_not_say">Prefer not to say</option>
            </select>
        </div>

        <div class="form-group">
            <label for="country">Country of Residence (for pricing)</label>
            <select id="country" required>
                <option value="" disabled selected>Select...</option>
                <option value="us">United States (USD)</option>
                <option value="eu">Europe (EUR)</option>
                <option value="uk">United Kingdom (GBP)</option>
                <option value="ca">Canada (CAD)</option>
                <option value="au">Australia (AUD)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="socialMediaUsage">How many hours per week do you spend on social media?</label>
            <input type="number" id="socialMediaUsage" min="0" placeholder="e.g., 10" required>
        </div>
        
        <button class="btn" onclick="saveDemographics()">Continue</button>
    </div>

    <div id="interfaceScreen" class="interface-screen">
        <h2>Select a Social Media Interface</h2>
        <p>To ensure a natural experience, please select the social media platform you are **most familiar** with for fashion/retail content.</p>
        
        <div class="interface-grid">
            <div class="interface-card" data-platform="facebook" onclick="selectPlatform(this)">
                <div class="icon">📘</div>
                <div class="name">Facebook</div>
                <div class="desc">The classic feed experience.</div>
            </div>
            <div class="interface-card" data-platform="instagram" onclick="selectPlatform(this)">
                <div class="icon">📸</div>
                <div class="name">Instagram</div>
                <div class="desc">Visual, high-quality images and shopping tags.</div>
            </div>
            <div class="interface-card" data-platform="linkedin" onclick="selectPlatform(this)">
                <div class="icon">💼</div>
                <div class="name">LinkedIn</div>
                <div class="desc">A professional/business-focused feed.</div>
            </div>
            <div class="interface-card" data-platform="tiktok" onclick="selectPlatform(this)">
                <div class="icon">🎵</div>
                <div class="name">TikTok</div>
                <div class="desc">Short-form vertical video feed.</div>
            </div>
        </div>
        
        <button id="startSurveyBtn" class="btn" onclick="startSurvey()" disabled>Start Survey</button>
    </div>

    <div id="surveyScreen" class="survey-screen">
        <div class="survey-header">
            <div class="progress-text">Post <span id="qCurrent">0</span> of <span id="qTotal">0</span></div>
            <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        </div>
        
        <div id="feed" class="feed">
            </div>
    </div>
    
    <div id="resultsScreen" class="results-screen">
        <h2>Survey Complete!</h2>
        <p>Thank you for completing the survey. Your responses have been recorded.</p>
        
        <div id="resultsBox" class="results-box">
            </div>
        
        <button class="btn" onclick="downloadData()">Finish and Download Data</button>
    </div>

</div>

<script>
var currentQuestion = 0; // Tracks the current active index (for TikTok) or the highest answered index (for others)
var selectedPlatform = '';
var startTime = null;
var answers = [];
var userData = {};
var isScrolling = false; // Flag to debounce TikTok scroll events
var answeredCount = 0; // Tracks the number of explicit interactions

// --- POST DATA (6 ADs, 6 ORGANIC, STABLE IMAGE URLS) ---
var posts = [
    // AD POSTS (6) - Shoppable Survey Items
    { id: 1, type: 'ad', shortText: 'The perfect minimalist tee to pair with anything. ✨', longText: 'Discover the ultimate minimalist tee: a versatile staple designed for effortless style. Made from 100% organic cotton, this shirt offers unparalleled comfort and sustainability. Perfect for a casual Friday or layering under a blazer. Click to shop our eco-friendly collection.', price: { us: 35, eu: 30, uk: 28, ca: 45, au: 50 }, brand: '@BrandThreads', avatar: 'B', imageUrl: 'https://picsum.photos/id/111/600/600' },
    { id: 2, type: 'ad', shortText: 'Stepping up the white sneaker game. Limited stock!', longText: 'Introducing our new line of eco-friendly, all-white urban sneakers. Engineered for comfort and designed for city life, these kicks feature recycled materials and a non-slip grip. Join the waitlist—limited stock available for the first drop.', price: { us: 120, eu: 105, uk: 95, ca: 155, au: 170 }, brand: '@UrbanKicksHQ', avatar: 'U', imageUrl: 'https://picsum.photos/id/112/600/600' },
    { id: 3, type: 'ad', shortText: 'Your new office favorite: the elegant tote. 👜', longText: 'Elevate your professional look with our spacious and elegant leather tote bag. Featuring a padded laptop sleeve and multiple internal pockets, it\'s the functional yet stylish accessory for the new season. Secure yours today and experience the blend of luxury and utility.', price: { us: 250, eu: 220, uk: 190, ca: 320, au: 350 }, brand: '@PouchLuxury', avatar: 'P', imageUrl: 'https://picsum.photos/id/113/600/600' },
    { id: 4, type: 'ad', shortText: 'The essential white shirt, redefined for comfort.', longText: 'The Classic button-down white shirt: Essential workwear redefined for modern comfort. Our innovative fabric blend is wrinkle-resistant and breathable, ensuring you look sharp from your first meeting to your last. A timeless investment for every wardrobe.', price: { us: 60, eu: 55, uk: 50, ca: 75, au: 85 }, brand: '@SharpWorkwear', avatar: 'W', imageUrl: 'https://picsum.photos/id/114/600/600' },
    { id: 5, type: 'ad', shortText: 'Oversized comfort in slate gray. Layer up!', longText: 'Unisex oversized hoodie in slate gray. Perfect for layering, this hoodie blends high-quality fleece with a modern streetwear fit. Durable, ultra-soft, and designed to last. Available in sizes XS-XXL. Shop the full color range now.', price: { us: 75, eu: 68, uk: 62, ca: 95, au: 110 }, brand: '@ChillStreetwear', avatar: 'C', imageUrl: 'https://picsum.photos/id/115/600/600' },
    { id: 6, type: 'ad', shortText: 'Run faster, feel better. New leggings drop! 🏃‍♀️', longText: 'Introducing our High-waisted running leggings, engineered with superior four-way stretch and advanced moisture-wicking technology. Designed to keep you comfortable through the toughest workouts. Reviewers say they are completely squat-proof!', price: { us: 90, eu: 80, uk: 75, ca: 115, au: 130 }, brand: '@ActiveProGear', avatar: 'A', imageUrl: 'https://picsum.photos/id/116/600/600' },
    
    // ORGANIC POSTS (6) - Non-commercial, Random Content
    { id: 7, type: 'organic', shortText: 'Check out my review of the new sci-fi movie!', longText: 'Just posted a detailed review of "Cosmic Echoes" on my blog. The plot twists were incredible! Link in comments. What did everyone else think? #scifi #movieReview', price: null, brand: '@film_junkie_daily', avatar: 'R', imageUrl: 'https://picsum.photos/id/201/600/600' },
    { id: 8, type: 'organic', shortText: 'A beautiful sunset after the rain. Never tire of this view.', longText: 'Captured this stunning sunset right after the storm cleared. Sometimes you just have to stop and appreciate the simple beauty of nature. Tag someone who needs to see this! #sunset #naturephotography #citylife', price: null, brand: '@urban_explorer', avatar: 'T', imageUrl: 'https://picsum.photos/id/202/600/600' },
    { id: 9, type: 'organic', shortText: 'Recipe test failed, but the kitchen smells amazing. 😅', longText: 'Tried that viral sourdough recipe, and well... it looks more like a frisbee than a loaf. Any expert bakers out there have tips? Send help (and flour). Full recipe link below!', price: null, brand: '@home_chef_fails', avatar: 'F', imageUrl: 'https://picsum.photos/id/203/600/600' },
    { id: 10, type: 'organic', shortText: 'Thoughts on the latest tech industry restructuring?', longText: 'The recent wave of large-scale industry restructuring raises interesting questions about future workforce models and remote integration. What impact do you see this having on innovation over the next 5 years? Share your professional insights.', price: null, brand: '@TechInsights_Global', avatar: 'G', imageUrl: 'https://picsum.photos/id/204/600/600' },
    { id: 11, type: 'organic', shortText: 'Just finished coding a new project! So satisfying.', longText: 'Spent the weekend wrapping up a big project integrating Python and React. The feeling of deploying clean code is unmatched. Excited to share the open-source repo soon! #codinglife #developer #webdev', price: null, brand: '@CodeFlow_Max', avatar: 'D', imageUrl: 'https://picsum.photos/id/205/600/600' },
    { id: 12, type: 'organic', shortText: 'Five essential books for entrepreneurs under 30. Link in bio!', longText: 'If you\'re starting your journey as an entrepreneur, these five books are non-negotiable reading. They cover everything from financing to mindset. Which book changed the way you think about business? Drop your favorites below!', price: null, brand: '@StartupMentor_HQ', avatar: 'M', imageUrl: 'https://picsum.photos/id/206/600/600' }
];

// --- ICONS (UNCHANGED) ---
var icons = {
    like: {
        facebook: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 11V21H17V11L14.5 7.5L15 4H9.5C9.25 4 9.04992 4.15008 9 4.4L8.7 6.4L7 11Z" fill="#65676B"/></svg>',
        instagram: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.27 2 8.5C2 5.41 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.41 22 8.5C22 12.27 18.6 15.36 13.45 20.03L12 21.35Z" fill="#262626"/></svg>',
        linkedin: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21C7.817 21 4.303 18.005 3.123 14H2V9H6V21H2V14.18C3.178 18.04 7.218 21 12 21C17.523 21 22 16.523 22 11C22 5.477 17.523 1 12 1C6.477 1 2 5.477 2 11H6C6 7.686 8.686 5 12 5C15.314 5 18 7.686 18 11C18 14.314 15.314 17 12 17H8V9H12C14.21 9 16 10.79 16 13C16 15.21 14.21 17 12 17Z" fill="#00000099"/></svg>',
        tiktok: '<svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.27 2 8.5C2 5.41 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.41 22 8.5C22 12.27 18.6 15.36 13.45 20.03L12 21.35Z" fill="white"/></svg>'
    },
    comment: {
        facebook: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 4C22 2.9 21.1 2 20 2H4C2.9 2 2 2.9 2 4V16C2 17.1 2.9 18 4 18H18L22 22V4Z" fill="#65676B"/></svg>',
        instagram: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 2H4C2.9 2 2 2.9 2 4V16C2 17.1 2.9 18 4 18H18L22 22V4C22 2.9 21.1 2 20 2ZM11 11H7V9H11V11ZM17 11H13V9H17V11Z" fill="#262626"/></svg>',
        linkedin: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 4C22 2.9 21.1 2 20 2H4C2.9 2 2 2.9 2 4V16C2 17.1 2.9 18 4 18H18L22 22V4Z" fill="#00000099"/></svg>',
        tiktok: '<svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 2H4C2.9 2 2 2.9 2 4V16C2 17.1 2.9 18 4 18H18L22 22V4C22 2.9 21.1 2 20 2Z" fill="white"/></svg>'
    },
    share: {
        facebook: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 1L8 5H11V14H13V5H16L12 1ZM4 19H20V21H4V19Z" fill="#65676B"/></svg>',
        instagram: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 3V10.59L17.17 12L2 13.41V21L22 12L2 3Z" fill="#262626"/></svg>',
        linkedin: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 1L8 5H11V14H13V5H16L12 1ZM4 19H20V21H4V19Z" fill="#00000099"/></svg>',
        tiktok: '<svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 1L8 5H11V14H13V5H16L12 1ZM4 19H20V21H4V19Z" fill="white"/></svg>'
    }
};

// --- HELPER FUNCTIONS (ORIGINAL) ---
function showScreen(id) {
    document.querySelectorAll('.screen, .demo-screen, .interface-screen, .survey-screen, .results-screen').forEach(function(screen) {
        screen.style.display = 'none';
    });
    document.getElementById(id).style.display = id === 'surveyScreen' ? 'flex' : 'block';
}

function getPriceForCountry(priceObj, country) {
    if (!priceObj) return '';
    var price = priceObj[country] || priceObj.us;
    var symbol = { us: '$', eu: '€', uk: '£', ca: 'C$', au: 'A$' }[country] || '$';
    return symbol + price;
}

// --- CORE LOGIC ---
function saveDemographics() {
    var age = document.getElementById('age').value;
    var gender = document.getElementById('gender').value;
    var country = document.getElementById('country').value;
    var usage = document.getElementById('socialMediaUsage').value;
    
    if (age && gender && country && usage) {
        userData = { age: age, gender: gender, country: country, socialMediaUsage: usage };
        showScreen('interfaceScreen');
    } else {
        alert('Please fill in all demographic fields.');
    }
}

function selectPlatform(card) {
    document.querySelectorAll('.interface-card').forEach(function(c) {
        c.classList.remove('selected');
    });
    card.classList.add('selected');
    selectedPlatform = card.dataset.platform;
    document.getElementById('startSurveyBtn').disabled = false;
}

function startSurvey() {
    if (!selectedPlatform) {
        alert('Please select a platform.');
        return;
    }
    
    // Randomize post order once at the start
    for (let i = posts.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [posts[i], posts[j]] = [posts[j], posts[i]];
    }
    
    // Initialize answers array with null/empty objects
    answers = Array(posts.length).fill(null).map((_, index) => ({
        postId: posts[index].id,
        postType: posts[index].type,
        action: null, // Default: no action taken yet
        reactionTimeMs: 0,
        price: posts[index].price ? (posts[index].price[userData.country] || posts[index].price.us) : null,
        platform: selectedPlatform
    }));
    
    // Reset counters
    currentQuestion = 0;
    answeredCount = 0;
    
    initSurvey();
    showScreen('surveyScreen');
    
    // Start total time tracking from this moment
    startTime = Date.now();
    updateProgressDisplay(0);

    // Conditionally set up the scroll handler only for TikTok
    if (selectedPlatform === 'tiktok') {
        document.getElementById('feed').addEventListener('scroll', handleTikTokScroll);
    }
}

// --- CORE LOGIC: POST GENERATION ---
function initSurvey() {
    var feed = document.getElementById('feed');
    feed.innerHTML = '';
    feed.className = 'feed ' + selectedPlatform;
    
    document.getElementById('qTotal').textContent = posts.length;
    
    posts.forEach(function(p, idx) {
        var isAd = p.type === 'ad';
        var price = getPriceForCountry(p.price, userData.country);
        var isTikTok = selectedPlatform === 'tiktok';
        var isInstagram = selectedPlatform === 'instagram';
        var isDescriptive = selectedPlatform === 'facebook' || selectedPlatform === 'linkedin';
        
        var postText = isDescriptive ? (isAd ? p.longText : p.longText + ' #organic') : p.shortText;

        var post = document.createElement('div');
        post.className = 'post ' + (isAd ? 'ad-post' : 'organic-post');
        post.dataset.index = idx;
        
        // --- Action Buttons HTML Generation ---
        var actionsHTML = '';
        
        if (isTikTok) {
            actionsHTML = '<div class="post-actions">' +
                '<button class="action-btn" onclick="answer(' + idx + ', \'like\')"><div class="action-icon">' + icons.like.tiktok + '</div><span>' + Math.floor(Math.random() * 500 + 1) + 'K</span></button>' +
                '<button class="action-btn" onclick="answer(' + idx + ', \'comment\')"><div class="action-icon">' + icons.comment.tiktok + '</div><span>' + Math.floor(Math.random() * 50 + 1) + 'K</span></button>' +
                '<button class="action-btn" onclick="answer(' + idx + ', \'share\')"><div class="action-icon">' + icons.share.tiktok + '</div><span>' + Math.floor(Math.random() * 5 + 1) + 'K</span></button>' +
                (isAd ? '<button class="action-btn buy-btn" onclick="answer(' + idx + ', \'buy\')"><span>Shop</span></button>' : '') +
                '</div>';
        } else {
            actionsHTML = '<div class="post-actions">' +
                '<button class="action-btn" onclick="answer(' + idx + ', \'like\')"><div class="action-icon">' + icons.like[selectedPlatform] + '</div><span>' + (isInstagram ? '' : 'Like') + '</span></button>' +
                '<button class="action-btn" onclick="answer(' + idx + ', \'comment\')"><div class="action-icon">' + icons.comment[selectedPlatform] + '</div><span>' + (isInstagram ? '' : 'Comment') + '</span></button>' +
                '<button class="action-btn" onclick="answer(' + idx + ', \'share\')"><div class="action-icon">' + icons.share[selectedPlatform] + '</div><span>' + (isInstagram ? '' : 'Share') + '</span></button>' +
                (isAd && isInstagram ? '<button class="action-btn buy-btn" onclick="answer(' + idx + ', \'buy\')">Shop Now</button>' : '') +
                '</div>';
        }

        // --- Post Header HTML Generation ---
        var headerHTML = '<div class="post-header">' +
            '<div class="post-avatar">' + p.avatar + '</div>' +
            '<div class="post-info">' +
            '<div class="brand">' + p.brand + (isDescriptive ? ' <span style="font-weight:400; color:#888;">• ' + (isAd ? 'Ad' : (selectedPlatform === 'linkedin' ? '2nd' : 'Following')) + '</span>' : '') + '</div>' + 
            '<div class="time">' + (isTikTok ? '@trendyshop' : '2h ago') + '</div>' + 
            '</div>' +
            (isAd ? '<div class="sponsored-label">Sponsored</div>' : '') +
            '</div>';

        // --- Post Content HTML Generation ---
        var contentHTML = '<div class="post-content">' +
            '<div class="post-text">' + postText + '</div>' +
            (isAd ? '<div class="post-price">' + price + '</div>' : '') +
            '</div>';
        
        // --- Image Div ---
        var imageDiv = '<div class="post-image" style="background-image: url(\'' + p.imageUrl + '\');"></div>';
        
        // --- Full Post Assembly ---
        if (isTikTok) {
            post.innerHTML = imageDiv + actionsHTML + contentHTML + headerHTML;
        } else if (isInstagram) {
            post.innerHTML = headerHTML + imageDiv + actionsHTML + contentHTML; 
        } else {
            post.innerHTML = headerHTML + contentHTML + imageDiv + actionsHTML;
            if (isAd) {
                post.innerHTML += '<div class="ad-cta-block"><button class="btn buy-btn" onclick="answer(' + idx + ', \'buy\')">Buy Now</button></div>';
            }
        }
        
        feed.appendChild(post);
    });

    // Manually scroll to the first post for TikTok (since it's not the top of the feed)
    if (selectedPlatform === 'tiktok') {
        document.querySelector('.post[data-index="0"]').scrollIntoView();
    }
}

// Function to update the progress bar/text
function updateProgressDisplay(index) {
    document.getElementById('qCurrent').textContent = index + 1;
    // Progress bar uses total posts, regardless of whether an action was taken
    document.getElementById('progressFill').style.width = ((index + 1) / posts.length) * 100 + '%';
}


// --- TIKTOK SPECIFIC NAVIGATION LOGIC (Swipe/Snap) ---
function handleTikTokScroll() {
    if (isScrolling) return; 
    isScrolling = true;

    setTimeout(() => {
        var feed = document.getElementById('feed');
        var snapDistance = feed.clientHeight;
        var visibleIndex = Math.round(feed.scrollTop / snapDistance); 
        var newQuestionIndex = visibleIndex;

        // If the user scrolled to a new post
        if (newQuestionIndex !== currentQuestion) {
            
            // 1. Record 'none' action for the *previous* question if unanswered
            if (answers[currentQuestion].action === null && currentQuestion < posts.length) {
                const reactionTime = Date.now() - startTime;
                answers[currentQuestion].action = 'none';
                answers[currentQuestion].reactionTimeMs = reactionTime;
                answeredCount++;
                // No visual highlight for a skip
            }

            // 2. Set the new current question and reset timer
            currentQuestion = newQuestionIndex;
            
            if (currentQuestion >= posts.length) {
                 showResults(); // End survey when scrolling past the last post
                 return;
            }

            startTime = Date.now();
            updateProgressDisplay(currentQuestion);
        }

        isScrolling = false;
    }, 150); // Small delay for scroll-snap transition
}


// --- INTERACTION LOGIC (Applicable to ALL platforms) ---
function answer(questionIndex, action) {
    
    // Only record if an action hasn't been taken on this post yet
    if (answers[questionIndex] && answers[questionIndex].action === null) {
        const reactionTime = Date.now() - startTime;
        
        // Update the answers data
        answers[questionIndex].action = action;
        answers[questionIndex].reactionTimeMs = reactionTime;
        answeredCount++;

        // Visual feedback and disable buttons
        highlightAnswer(questionIndex, action);
        
        // --- HYBRID LOGIC ---
        if (selectedPlatform === 'tiktok') {
            // TikTok: Force scroll to the next post immediately after explicit interaction
            currentQuestion = questionIndex; // Ensure currentQuestion is correct for the logic below
            if (currentQuestion < posts.length - 1) {
                // Manually scroll down to the next post
                const feed = document.getElementById('feed');
                feed.scrollBy({ top: feed.clientHeight, behavior: 'smooth' });
                // handleTikTokScroll will pick up the new position and reset the timer
            } else {
                // Last post answered
                showResults();
            }
        }
        
        // For FB/IG/LI: Timer is not reset until the end, only the action is recorded.
        // Progress bar updates only on explicit action for continuous feeds
        if (selectedPlatform !== 'tiktok') {
            updateProgressDisplay(questionIndex);
        }
    }
}

// Helper to visually confirm an action and disable other buttons
function highlightAnswer(questionIndex, action) {
    var currentPost = document.querySelector('.post[data-index="' + questionIndex + '"]');
    
    if (!currentPost) return;

    // Disable all buttons for this post once answered
    currentPost.querySelectorAll('button').forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = 0.4;
    });

    // Highlight the button that was pressed
    currentPost.querySelectorAll('button').forEach(btn => {
        const btnText = btn.textContent.toLowerCase();
        
        let isMatch = false;
        if (action === 'like' && btnText.includes('like')) isMatch = true;
        if (action === 'comment' && btnText.includes('comment')) isMatch = true;
        if (action === 'share' && btnText.includes('share')) isMatch = true;
        if (action === 'buy' && (btnText.includes('buy now') || btnText.includes('shop'))) isMatch = true;

        if (isMatch) {
            btn.style.opacity = 1;
            btn.style.color = selectedPlatform === 'tiktok' ? '#FE2C55' : (selectedPlatform === 'facebook' ? '#1877f2' : (selectedPlatform === 'linkedin' ? '#0a66c2' : '#c13584'));
        }
    });
}

// --- RESULTS & DATA EXPORT (UNTOUCHED ANALYTICS) ---
function showResults() {
    // For FB/IG/LI, we mark remaining unclicked posts as 'none' with the average time taken for explicit clicks.
    // For TikTok, all times are already individually recorded by the scroll listener.
    const finalAnswers = answers.filter(a => a.action !== null);
    
    // Total elapsed time from start to finish
    const totalSurveyDuration = Date.now() - startTime;
    
    // Calculate total time from recorded actions (excluding 'none' for FB/IG/LI)
    let totalTimeFromActions = answers.filter(a => a.action !== 'none').reduce((sum, a) => sum + a.reactionTimeMs, 0);
    
    // If no actions were taken, use the total duration for average calculation.
    if (totalTimeFromActions === 0) {
        totalTimeFromActions = totalSurveyDuration;
    }

    // Replace all 'null' actions with 'none' and assign the average time taken for explicit action to the reactionTimeMs for the 'none' entries.
    // This is the accepted "slightly inaccurate" data compensation.
    const totalExplicitActions = answers.filter(a => a.action !== null && a.action !== 'none').length;
    const avgExplicitTime = totalExplicitActions > 0 ? totalTimeFromActions / totalExplicitActions : 0;
    
    answers.forEach(a => {
        if (a.action === null) {
            a.action = 'none';
            a.reactionTimeMs = avgExplicitTime;
        }
    });
    
    // Recalculate total time after filling in 'none' gaps
    const finalTotalTimeMs = answers.reduce((sum, a) => sum + a.reactionTimeMs, 0);
    const finalTotalTimeS = finalTotalTimeMs / 1000;
    const finalAvgTimeS = finalTotalTimeS / posts.length;


    showScreen('resultsScreen');
    
    document.getElementById('resultsBox').innerHTML = '<h3>Summary</h3><p><strong>Platform:</strong> ' + selectedPlatform.charAt(0).toUpperCase() + selectedPlatform.slice(1) + '</p><p><strong>Posts Viewed:</strong> ' + posts.length + '</p><p><strong>Total Time:</strong> ' + Math.floor(finalTotalTimeS / 60) + ':' + String(Math.floor(finalTotalTimeS % 60)).padStart(2, '0') + ' mins</p><p><strong>Average Response:</strong> ' + finalAvgTimeS.toFixed(1) + 's</p><p style="margin-top:16px;font-style:italic;">Thank you for contributing to fashion retail research!</p>';
}

function downloadData() {
    // The answers array has now been fully processed by showResults()
    var data = {
        demographics: userData,
        platform: selectedPlatform,
        answers: answers,
        totalTime: answers.reduce((sum, a) => sum + a.reactionTimeMs, 0),
        timestamp: new Date().toISOString()
    };
    
    // NOTE: REPLACE 'YOUR_GOOGLE_SCRIPT_URL_HERE' with your actual Google Apps Script URL
    fetch('YOUR_GOOGLE_SCRIPT_URL_HERE', {
        method: 'POST',
        mode: 'no-cors',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).catch(function(err) {
        console.log('Upload failed:', err);
    });
    
    // Also download locally as backup
    var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'survey-data-' + Date.now() + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Initial display setup
document.addEventListener('DOMContentLoaded', function() {
    showScreen('consentScreen');
});
</script>
</body>
</html>
